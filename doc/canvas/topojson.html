<!DOCTYPE html>
<meta charset="utf-8">
<head>
    <title>topojson</title>
</head>
<body>

<script src="//d3js.org/d3.v3.min.js"></script>
<script src="//d3js.org/topojson.v1.min.js"></script>
<script>
    // http://bl.ocks.org/mbostock/3680958
    // http://bl.ocks.org/mbostock/7755778
    // https://bl.ocks.org/mbostock/6245977


var width = 800,
    height = 800;

var projection = d3.geo.mercator()
    .center([104, 36])
    .scale(600)
    .translate([width/2, height/2]);

var canvas = d3.select("body").append("canvas")
    .attr("width", width)
    .attr("height", height);

var context = canvas.node().getContext("2d");

var path = d3.geo.path()
    .projection(projection)
    .context(context);

d3.json("../../tmp/world-50m.json", function(error, world) {
    d3.json("../../tmp/china.json", function(error, china) {
        if (error) throw error;

        // china = topojson.presimplify(china)
        // path(topojson.feature(china, china.objects.china_province)) // 970ms
        // path(topojson.mesh(china, china.objects.china_province)) // 420ms   
        
        // separating interior and exterior boundaries
        let interior = topojson.mesh(china, china.objects.china_province, function(a, b) { return a !== b; })   // 50ms
        console.log(interior)
        let exterior = topojson.mesh(china, china.objects.china_province, function(a, b) { return a === b; })   // 110ms
        console.log(exterior)

        let countries = topojson.mesh(world, world.objects.countries)
        console.log(countries)
        
        context.lineWidth = '1'
        context.strokeStyle = '#c9c4bc'
        draw()
        function draw() {
            let begin = Date.now()
            context.beginPath()

            // countries.coordinates = countries.coordinates.filter(el => {
            //     return el.some(point => )
            // })

            path(countries)
            path(interior)  // 120ms
            path(exterior)  // 65ms
            context.stroke();
            console.log(Date.now() - begin)  // 320ms
        }
        
        canvas.call(d3.behavior.zoom().scaleExtent([1, 8]).on("zoom", zoom))
        function zoom() {
            context.save()
            context.clearRect(0, 0, width, height)
            context.translate(d3.event.translate[0], d3.event.translate[1])
            // context.scale(d3.event.scale, d3.event.scale)
            console.log(d3.event)
            projection.scale(d3.event.scale)
            draw()
            context.restore()
        }

    });
});








</script>